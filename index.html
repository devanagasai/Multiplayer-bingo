<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Bingo game */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem;
            max-width: 1200px; /* Increased max-width for the entire container */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .game-area {
            display: flex;
            flex-direction: row;
            gap: 2rem;
            width: 100%;
            justify-content: center;
            align-items: flex-start;
        }

        .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px; /* Larger gap for a better visual */
            width: 100%;
            max-width: 750px; /* Increased max-width for a larger card */
            border: 2px solid #3b82f6; /* Blue border */
            border-radius: 0.75rem;
            overflow: hidden; /* Ensures rounded corners apply to cells */
        }

        .bingo-header-cell, .bingo-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem 0.75rem; /* Decreased padding for a shorter card */
            font-weight: bold;
            color: #ffffff;
            text-align: center;
            border-radius: 0.25rem; /* Slightly rounded cell corners */
            user-select: none; /* Prevent text selection */
        }

        .bingo-header-cell {
            background-color: #3b82f6; /* Blue header */
            font-size: 1.75rem; /* Decreased font size */
        }

        .bingo-cell {
            background-color: #e0f2fe; /* Light blue for numbers */
            color: #1e40af; /* Darker blue text */
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-size: 1.6rem; /* Decreased font size */
        }
        
        .bingo-cell.marked {
            background-color: #10b981; /* Green for marked cells */
            color: #ffffff;
            transform: scale(1.05);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        }

        .bingo-cell.active-turn:hover {
            background-color: #bfdbfe; /* Lighter blue on hover for active player */
            transform: scale(1.02);
        }
        
        .bingo-cell.last-called {
            border: 3px solid #f97316; /* Orange border for the last called number */
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .button-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105;
        }

        .button-secondary {
            @apply bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-105;
        }

        .message-box {
            background-color: #fff;
            border: 2px solid #3b82f6;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 1rem;
            max-width: 90%;
            min-width: 300px;
        }

        .message-box h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e40af;
        }

        .message-box p {
            font-size: 1.1rem;
            color: #374151;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none; /* Hidden by default */
        }

        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .container {
                padding: 1rem;
                gap: 1rem;
                max-width: 90%;
            }
            .game-area {
                flex-direction: column;
            }
            .bingo-card {
                max-width: 100%;
            }
            .bingo-header-cell, .bingo-cell {
                padding: 0.75rem 0.5rem;
                font-size: 1.1rem;
            }
            .button-primary, .button-secondary {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
            }
            .message-box h3 {
                font-size: 1.25rem;
            }
            .message-box p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-extrabold text-blue-800 mb-4">Multiplayer Bingo! (1-25)</h1>

        <div class="flex flex-col sm:flex-row gap-4 sm:gap-8 items-center text-lg font-medium text-gray-700">
            <div>Your User ID: <span id="userIdDisplay" class="text-blue-600 break-all">Loading...</span></div>
            <div>Game ID: <span id="gameIdDisplay" class="text-blue-600 break-all">Not in a game</span></div>
            <div>Your Name: <span id="playerNameDisplay" class="text-blue-600 break-all"></span></div>
        </div>

        <div id="lobbySection" class="flex flex-col items-center gap-4 w-full max-w-md bg-gray-100 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">Join or Create Game</h2>
            <input type="text" id="playerNameInput" placeholder="Enter Your Name (e.g., 'Player 1')" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="text" id="gameIdInput" placeholder="Enter Game ID (e.g., '123456')" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="joinGameBtn" class="button-primary w-full">Join Game</button>
            <div class="text-gray-500">- OR -</div>
            <button id="createGameBtn" class="button-secondary w-full">Create New Game</button>
            <div id="loadingSpinner" class="loading-spinner"></div>
        </div>

        <div id="gameSection" class="hidden flex-col items-center gap-4 w-full">
            <div class="flex flex-col items-center gap-2 w-full">
                <div class="text-2xl font-semibold text-gray-700">Last Called: <span id="lastCalledNumber" class="text-blue-600">--</span></div>
                <div class="text-xl font-semibold text-gray-700">Current Turn: <span id="currentTurnDisplay" class="text-purple-600">--</span></div>
            </div>

            <div class="game-area">
                <div class="flex flex-col items-center">
                    <div class="text-xl font-bold text-gray-800 mb-2">Your Card</div>
                    <div class="bingo-card" id="bingoCard">
                    </div>
                </div>

                <div class="flex flex-col gap-4 w-full max-w-sm">
                    <div class="w-full bg-gray-100 p-4 rounded-lg shadow-inner">
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">Players in Game:</h2>
                        <ul id="playersList" class="text-gray-600 space-y-1">
                            </ul>
                    </div>

                    <div class="w-full bg-gray-100 p-4 rounded-lg shadow-inner">
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">Called Numbers:</h2>
                        <div id="calledNumbersList" class="flex flex-wrap gap-2 text-gray-600 text-lg">
                            </div>
                    </div>

                    <div class="w-full bg-gray-100 p-4 rounded-lg shadow-inner">
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">Game Chat:</h2>
                        <div id="chatMessages" class="h-40 overflow-y-auto bg-white p-2 rounded-lg mb-2 text-sm space-y-1">
                            </div>
                        <div class="flex gap-2">
                            <input type="text" id="chatInput" placeholder="Type a message..." class="flex-grow p-2 border border-gray-300 rounded-lg">
                            <button id="sendMessageBtn" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg font-bold transition">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <button id="resetGameBtn" class="button-secondary hidden mt-4">Reset Game</button>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="message-box" id="messageBox">
        <h3 id="messageTitle"></h3>
        <p id="messageContent"></p>
        <button id="messageBoxOkBtn" class="button-primary mt-4">OK</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, increment, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your Firebase project credentials
        const firebaseConfig = {
          apiKey: "AIzaSyDmCigU3UNAB3FeQbOMK_CrHCjg63LD9SE",
          authDomain: "bingo-2d37c.firebaseapp.com",
          projectId: "bingo-2d37c",
          storageBucket: "bingo-2d37c.firebasestorage.app",
          messagingSenderId: "875853617298",
          appId: "1:875853617298:web:277c40362ae2af0a9dae4b",
          measurementId: "G-JKYKY9CN23"
        };
        
        // --- Do not modify the code below this line ---

        // Firebase App and services variables
        let app;
        let db;
        let auth;
        const APP_ID = firebaseConfig.projectId;

        // Game state variables
        let currentUserId = null;
        let currentGameId = null;
        let playerCard = [];
        let isHost = false;
        let unsubscribeFromGame = null;
        let unsubscribeFromChat = null;
        let currentPlayerName = '';

        // DOM elements
        const userIdDisplay = document.getElementById('userIdDisplay');
        const gameIdDisplay = document.getElementById('gameIdDisplay');
        const playerNameDisplay = document.getElementById('playerNameDisplay');
        const lobbySection = document.getElementById('lobbySection');
        const playerNameInput = document.getElementById('playerNameInput');
        const gameIdInput = document.getElementById('gameIdInput');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const createGameBtn = document.getElementById('createGameBtn');
        const gameSection = document.getElementById('gameSection');
        const lastCalledNumberSpan = document.getElementById('lastCalledNumber');
        const currentTurnDisplay = document.getElementById('currentTurnDisplay');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const bingoCardElement = document.getElementById('bingoCard');
        const calledNumbersList = document.getElementById('calledNumbersList');
        const playersList = document.getElementById('playersList');
        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageContent = document.getElementById('messageContent');
        const messageBoxOkBtn = document.getElementById('messageBoxOkBtn');
        const overlay = document.getElementById('overlay');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        
        // Helper variable for event listener management
        let isTurnToCall = false;

        /**
         * Shows the loading spinner.
         */
        function showLoading() {
            loadingSpinner.style.display = 'block';
            joinGameBtn.disabled = true;
            createGameBtn.disabled = true;
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoading() {
            loadingSpinner.style.display = 'none';
            joinGameBtn.disabled = false;
            createGameBtn.disabled = false;
        }

        /**
         * Initializes Firebase and sets up an auth state listener.
         */
        function setupAuthListener() {
            if (!firebaseConfig.apiKey) {
                userIdDisplay.textContent = 'Error: Firebase config missing!';
                showMessage('Setup Error', 'Firebase configuration is missing or invalid.');
                console.error('Firebase configuration is missing or invalid. Cannot initialize Firebase.');
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = currentUserId.substring(0, 8);
                    console.log('User authenticated:', currentUserId);
                } else {
                    console.log('User not signed in. Attempting anonymous sign-in.');
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error('Anonymous sign-in failed:', error);
                        showMessage('Authentication Error', 'Could not sign in. Please check your Firebase configuration and network connection.');
                    }
                }
            });
        }

        /**
         * Generates a new Bingo card with 25 unique, shuffled numbers from 1 to 25.
         */
        function generateBingoCard() {
            const numbers = Array.from({ length: 25 }, (_, i) => i + 1);
            return shuffleArray(numbers);
        }

        /**
         * Shuffles an array in place (Fisher-Yates algorithm).
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Renders the Bingo card to the DOM and automatically marks called numbers.
         */
        function renderBingoCard(gameData) {
            bingoCardElement.innerHTML = ''; // Clear previous card

            const headers = ['B', 'I', 'N', 'G', 'O'];
            headers.forEach(header => {
                const headerCell = document.createElement('div');
                headerCell.className = 'bingo-header-cell';
                headerCell.textContent = header;
                bingoCardElement.appendChild(headerCell);
            });

            const calledNumbersSet = new Set(gameData?.calledNumbers || []);
            const lastCalledNumber = gameData?.lastCalledNumber;

            playerCard.forEach((number, index) => {
                const cell = document.createElement('div');
                cell.className = 'bingo-cell';
                cell.textContent = number;
                cell.dataset.index = index;

                if (calledNumbersSet.has(number)) {
                    cell.classList.add('marked');
                }

                if (number === lastCalledNumber) {
                    cell.classList.add('last-called');
                }
                
                // Add a class to indicate the card is clickable if it's the player's turn
                if (isTurnToCall) {
                    cell.classList.add('active-turn');
                } else {
                    cell.classList.remove('active-turn');
                }

                bingoCardElement.appendChild(cell);
            });
        }

        /**
         * Checks if a Bingo has been achieved on the player's card and notifies other players.
         */
        async function checkForBingo() {
            if (!currentGameId || !currentUserId) return;

            const gameRef = doc(db, `artifacts/${APP_ID}/public/data/bingoGames`, currentGameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;
            const gameData = gameSnap.data();

            // FIX: Stop checking for bingo and updating the score if the game has already ended.
            if (gameData.status === 'bingo') {
                return;
            }

            const calledNumbersSet = new Set(gameData.calledNumbers || []);
            const playerMarkedCells = new Set(playerCard
                .map((num, index) => calledNumbersSet.has(num) ? index : -1)
                .filter(index => index !== -1));

            const lines = [
                // Rows
                [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
                // Columns
                [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
                // Diagonals
                [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
            ];
            
            let bingoCount = 0; // Initialize a counter for completed lines

            for (const line of lines) {
                const isBingo = line.every(index => playerMarkedCells.has(index));
                if (isBingo) {
                    bingoCount++; // Increment the counter for each completed line
                }
            }

            // Only check for a win if 5 or more lines are completed
            if (bingoCount >= 5) {
                await updateDoc(gameRef, {
                    status: 'bingo',
                    winnerId: currentUserId,
                    [`players.${currentUserId}.score`]: increment(1)
                });
                return;
            }
        }

        /**
         * Host function: Calls a random unique number and updates Firestore.
         */
        async function callNextNumber(number) {
            if (!currentGameId) return;

            const gameRef = doc(db, `artifacts/${APP_ID}/public/data/bingoGames`, currentGameId);
            try {
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) {
                    showMessage('Game Error', 'Game not found. Please create or join a new game.');
                    return;
                }
                const gameData = gameSnap.data();
                
                const numToCall = parseInt(number, 10);
                
                // This is the core logic change.
                if (!isTurnToCall) {
                    showMessage('Not Your Turn', 'It is not your turn to call a number.');
                    return;
                }

                if (gameData.status === 'bingo') {
                    showMessage('Game Over', 'The game has already ended. Please reset to start a new round.');
                    return;
                }

                let calledNumbers = new Set(gameData.calledNumbers || []);
                
                if (calledNumbers.has(numToCall)) {
                    showMessage('Number Already Called', `The number ${numToCall} has already been called. Please choose another.`);
                    return;
                }

                calledNumbers.add(numToCall);

                const nextTurnIndex = (gameData.currentTurnIndex + 1) % gameData.turnOrder.length;
                
                await updateDoc(gameRef, {
                    calledNumbers: Array.from(calledNumbers),
                    lastCalledNumber: numToCall,
                    status: 'playing',
                    currentTurnIndex: nextTurnIndex
                });

            } catch (error) {
                console.error('Error calling number:', error);
                showMessage('Error', 'Could not call number. Please try again.');
            }
        }

        /**
         * Updates the list of called numbers displayed on the screen.
         */
        function updateCalledNumbersList(numbers) {
            calledNumbersList.innerHTML = '';
            const sortedCalledNumbers = numbers.sort((a, b) => a - b);
            sortedCalledNumbers.forEach(num => {
                const span = document.createElement('span');
                span.className = 'bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium';
                span.textContent = num;
                calledNumbersList.appendChild(span);
            });
        }

        /**
         * Host function: Resets the game state in Firestore.
         */
        async function resetGame() {
            if (!isHost || !currentGameId) return;

            const gameRef = doc(db, `artifacts/${APP_ID}/public/data/bingoGames`, currentGameId);
            try {
                const gameSnap = await getDoc(gameRef);
                const gameData = gameSnap.data();
                const currentPlayers = gameData.players || {};

                // Generate new cards for all existing players
                const newPlayersState = {};
                const currentTurnOrder = [];
                for (const playerId in currentPlayers) {
                    newPlayersState[playerId] = {
                        card: generateBingoCard(),
                        markedCells: [],
                        name: currentPlayers[playerId].name,
                        score: currentPlayers[playerId].score // Preserve scores
                    };
                    currentTurnOrder.push(playerId);
                }

                // If there's more than one player, ensure the next player starts
                let initialTurnIndex = 0;
                if (currentTurnOrder.length > 1) {
                    let lastHostIndex = currentTurnOrder.indexOf(gameData.hostId);
                    if (lastHostIndex !== -1) {
                        const nextPlayerIndex = (lastHostIndex + 1) % currentTurnOrder.length;
                        if (currentTurnOrder[nextPlayerIndex] === gameData.hostId) {
                            // If the host is the only non-host player, keep them as starter
                            initialTurnIndex = lastHostIndex;
                        } else {
                            initialTurnIndex = nextPlayerIndex;
                        }
                    }
                }
                
                await updateDoc(gameRef, {
                    calledNumbers: [],
                    lastCalledNumber: null,
                    status: 'waiting',
                    winnerId: null,
                    players: newPlayersState,
                    turnOrder: currentTurnOrder,
                    currentTurnIndex: initialTurnIndex
                });
                showMessage('Game Reset', 'The game has been reset. A new round can begin!');
            } catch (error) {
                console.error('Error resetting game:', error);
                showMessage('Error', 'Could not reset game. Please try again.');
            }
        }

        /**
         * Creates a new Bingo game room in Firestore.
         */
        async function createGame() {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                showMessage('Name Required', 'Please enter your name before creating a game.');
                return;
            }
            currentPlayerName = playerName;
            showLoading();
            try {
                let newGameId = '';
                let gameExists = true;
                while (gameExists) {
                    newGameId = Math.floor(100000 + Math.random() * 900000).toString();
                    const gameRef = doc(db, `artifacts/${APP_ID}/public/data/bingoGames`, newGameId);
                    const gameSnap = await getDoc(gameRef);
                    gameExists = gameSnap.exists();
                }

                const newGameRef = doc(db, `artifacts/${APP_ID}/public/data/bingoGames`, newGameId);
                const newPlayerCard = generateBingoCard();

                await setDoc(newGameRef, {
                    hostId: currentUserId,
                    players: {
                        [currentUserId]: {
                            card: newPlayerCard,
                            markedCells: [],
                            name: currentPlayerName,
                            score: 0
                        }
                    },
                    calledNumbers: [],
                    lastCalledNumber: null,
                    status: 'waiting',
                    createdAt: new Date(),
                    turnOrder: [currentUserId],
                    currentTurnIndex: 0
                });

                currentGameId = newGameId;
                isHost = true;
                playerCard = newPlayerCard;
                startGameListener(newGameId);
                startChatListener(newGameId);
                showMessage('Game Created!', `Share this Game ID with your friend: <br><strong class="break-all">${newGameId}</strong>`);
            } catch (error) {
                console.error('Error creating game:', error);
                showMessage('Error', 'Could not create game. Please try again.');
            } finally {
                hideLoading();
            }
        }

        /**
         * Joins an existing Bingo game room.
         */
        async function joinGame(gameId) {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                showMessage('Name Required', 'Please enter your name before joining a game.');
                return;
            }
            if (!gameId || gameId.length !== 6) {
                showMessage('Invalid Game ID', 'Please enter a valid 6-digit Game ID to join.');
                return;
            }
            currentPlayerName = playerName;
            showLoading();
            try {
                const gameRef = doc(db, `artifacts/${APP_ID}/public/data/bingoGames`, gameId);
                const gameSnap = await getDoc(gameRef);

                if (!gameSnap.exists()) {
                    showMessage('Game Not Found', 'The entered Game ID does not exist.');
                    hideLoading();
                    return;
                }

                const gameData = gameSnap.data();
                if (gameData.players && Object.keys(gameData.players).length >= 5) {
                    showMessage('Game Full', 'This game is full. Maximum 5 players allowed.');
                    hideLoading();
                    return;
                }

                // Get or create player data
                let newPlayerCard = generateBingoCard();
                let newTurnOrder = gameData.turnOrder || [];
                let newCurrentTurnIndex = gameData.currentTurnIndex || 0;
                
                // If the player is rejoining, use their old card and marked cells
                if (gameData.players && gameData.players[currentUserId]) {
                    newPlayerCard = gameData.players[currentUserId].card;
                } else {
                     // Add new player to the game and update turn order
                    const playerPath = `players.${currentUserId}`;
                    newTurnOrder.push(currentUserId);
                    await updateDoc(gameRef, {
                        [playerPath]: {
                            card: newPlayerCard,
                            markedCells: [],
                            name: currentPlayerName,
                            score: 0
                        },
                        turnOrder: newTurnOrder,
                        currentTurnIndex: newCurrentTurnIndex
                    });
                }

                currentGameId = gameId;
                isHost = (gameData.hostId === currentUserId);
                playerCard = newPlayerCard;
                startGameListener(gameId);
                startChatListener(gameId);
                showMessage('Game Joined!', `You have joined game ID: <br><strong class="break-all">${gameId}</strong>`);
            } catch (error) {
                console.error('Error joining game:', error);
                showMessage('Error', 'Could not join game. Please try again.');
            } finally {
                hideLoading();
            }
        }

        /**
         * Starts listening for real-time updates to the game state from Firestore.
         */
        function startGameListener(gameId) {
            if (unsubscribeFromGame) unsubscribeFromGame();
            const gameRef = doc(db, `artifacts/${APP_ID}/public/data/bingoGames`, gameId);
            unsubscribeFromGame = onSnapshot(gameRef, (docSnap) => {
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    console.log('Game data updated:', gameData);
                    
                    gameIdDisplay.textContent = currentGameId;
                    playerNameDisplay.textContent = currentPlayerName;
                    lobbySection.classList.add('hidden');
                    gameSection.classList.remove('hidden');

                    lastCalledNumberSpan.textContent = gameData.lastCalledNumber || '--';
                    updateCalledNumbersList(gameData.calledNumbers || []);
                    
                    if (gameData.players && gameData.players[currentUserId]) {
                        playerCard = gameData.players[currentUserId].card;
                    }
                    
                    // Check if it's the current user's turn
                    isTurnToCall = (gameData.turnOrder && gameData.turnOrder.length > 0 && currentUserId === gameData.turnOrder[gameData.currentTurnIndex]);

                    renderBingoCard(gameData);
                    updatePlayersList(gameData.players, gameData.turnOrder);
                    
                    // Update current turn display
                    if (gameData.turnOrder && gameData.turnOrder.length > 0 && gameData.currentTurnIndex !== undefined) {
                        const currentCallerId = gameData.turnOrder[gameData.currentTurnIndex];
                        const callerName = gameData.players[currentCallerId]?.name || currentCallerId.substring(0, 8);
                        currentTurnDisplay.textContent = currentCallerId === currentUserId ? 'You' : callerName;
                    } else {
                        currentTurnDisplay.textContent = '--';
                    }

                    if (gameData.hostId === currentUserId) {
                        resetGameBtn.classList.remove('hidden');
                        // FIX: Remove the line that disables the button on a win.
                        // resetGameBtn.disabled = gameData.status === 'bingo';
                    } else {
                        resetGameBtn.classList.add('hidden');
                    }

                    // Handle game status messages
                    if (gameData.status === 'bingo' && gameData.winnerId) {
                        const winnerName = gameData.players[gameData.winnerId]?.name || gameData.winnerId.substring(0, 8);
                        if (gameData.winnerId === currentUserId) {
                            showMessage('You Won!', 'Congratulations! You got a Bingo!');
                        } else {
                            showMessage('Game Over!', `${winnerName} got a Bingo!`);
                        }
                    }

                    checkForBingo(); // Check for bingo automatically on every update
                } else {
                    showMessage('Game Ended', 'The game you were in has ended or was deleted.');
                    leaveGame();
                }
            }, (error) => {
                console.error('Firestore listener error:', error);
                showMessage('Connection Error', 'Lost connection to the game. Please try rejoining.');
                leaveGame();
            });
        }
        
        /**
         * Starts a listener for new chat messages.
         */
        function startChatListener(gameId) {
            if (unsubscribeFromChat) unsubscribeFromChat();
            const chatRef = collection(db, `artifacts/${APP_ID}/public/data/bingoGames/${gameId}/chat`);
            const q = query(chatRef, orderBy('timestamp', 'asc'), limit(50));
            unsubscribeFromChat = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = ''; // Clear chat
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const messageElement = document.createElement('div');
                    messageElement.className = 'text-gray-800';
                    messageElement.innerHTML = `<strong>${message.senderName}:</strong> ${message.text}`;
                    chatMessages.appendChild(messageElement);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to the bottom
            }, (error) => {
                console.error('Chat listener error:', error);
            });
        }
        
        /**
         * Sends a new chat message to Firestore.
         */
        async function sendMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === '' || !currentGameId) return;

            const chatRef = collection(db, `artifacts/${APP_ID}/public/data/bingoGames/${currentGameId}/chat`);
            try {
                await addDoc(chatRef, {
                    senderId: currentUserId,
                    senderName: currentPlayerName,
                    text: messageText,
                    timestamp: new Date()
                });
                chatInput.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }
        
        /**
         * Updates the list of players displayed in the UI.
         */
        function updatePlayersList(players, turnOrder) {
            playersList.innerHTML = '';
            if (players) {
                const sortedPlayers = turnOrder.map(id => players[id]);
                sortedPlayers.forEach((player, index) => {
                    if (player) {
                        const isCurrentTurn = turnOrder[index] === currentUserId;
                        const listItem = document.createElement('li');
                        listItem.className = isCurrentTurn ? 'font-bold text-purple-600' : '';
                        listItem.textContent = `${player.name} (Score: ${player.score}) ${isCurrentTurn ? ' (Your turn)' : ''}`;
                        playersList.appendChild(listItem);
                    }
                });
            }
        }

        /**
         * Leaves the current game and returns to the lobby.
         */
        function leaveGame() {
            if (unsubscribeFromGame) unsubscribeFromGame();
            if (unsubscribeFromChat) unsubscribeFromChat();
            currentGameId = null;
            isHost = false;
            playerCard = [];

            gameIdDisplay.textContent = 'Not in a game';
            playerNameDisplay.textContent = '';
            lobbySection.classList.remove('hidden');
            gameSection.classList.add('hidden');
            lastCalledNumberSpan.textContent = '--';
            calledNumbersList.innerHTML = '';
            bingoCardElement.innerHTML = '';
            gameIdInput.value = '';
            currentTurnDisplay.textContent = '--';
            playersList.innerHTML = '';
            chatMessages.innerHTML = '';
        }

        /**
         * Displays a custom message box.
         */
        function showMessage(title, content) {
            messageTitle.innerHTML = title;
            messageContent.innerHTML = content;
            messageBox.style.display = 'flex';
            overlay.style.display = 'block';
        }

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            messageBox.style.display = 'none';
            overlay.style.display = 'none';
        }

        // Event Listeners
        joinGameBtn.addEventListener('click', () => {
            joinGame(gameIdInput.value.trim());
        });
        createGameBtn.addEventListener('click', createGame);
        resetGameBtn.addEventListener('click', resetGame);
        messageBoxOkBtn.addEventListener('click', hideMessage);
        overlay.addEventListener('click', hideMessage);
        sendMessageBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // NEW: Event listener for clicking on the bingo card to call a number
        bingoCardElement.addEventListener('click', (e) => {
            if (e.target.classList.contains('bingo-cell')) {
                const number = e.target.textContent;
                callNextNumber(number);
            }
        });

        // Initialize authentication when the page loads
        window.onload = setupAuthListener;
    </script>
</body>
</html>